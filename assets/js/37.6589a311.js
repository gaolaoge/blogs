(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{486:function(a,s,e){"use strict";e.r(s);var t=e(12),r=Object(t.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("缓存（Cache）是计算机领域里的 1 个重要概念，是优化系统性能的重要方式。")]),a._v(" "),s("p",[a._v("网络链路漫长，时延不可控，浏览器使用 HTTP 获取资源的成本较高。把数据缓存起来尽可能地复用。可以避免重复的通信成本，节约网络带宽，也可以加快响应速度。")]),a._v(" "),s("p",[a._v("HTTP 传输的每一个环节基本上都会有缓存，非常复杂。")]),a._v(" "),s("p",[a._v("流程：")]),a._v(" "),s("ul",[s("li",[a._v("流览器发起请求，")]),a._v(" "),s("li",[a._v("浏览器查找缓存无数据，于是发送请求，向服务器获取资源；")]),a._v(" "),s("li",[a._v("服务器响应请求，返回资源，同时标记资源的有效期；")]),a._v(" "),s("li",[a._v("浏览器缓存资源，等待下次重用。")])]),a._v(" "),s("h3",{attrs:{id:"服务器的缓存控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务器的缓存控制"}},[a._v("#")]),a._v(" 服务器的缓存控制")]),a._v(" "),s("p",[a._v("服务器标记资源有效期的头字段是“Cache-Control”，里面的值“max-age=30”就是资源的有效时间。")]),a._v(" "),s("blockquote",[s("p",[a._v("这里的 max-age 的计算起点是响应报文的创建时刻（即 Date 字段，也就是离开服务器的时刻），包含了在链路传输过程中所有节点所停留的时间。")])]),a._v(" "),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token response-status"}},[s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token status-code number"}},[a._v("200")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token reason-phrase string"}},[a._v("OK")])]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Cache-Control")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("max-age=30")])]),a._v("\n")])])]),s("p",[a._v("no-store：不允许缓存，用于某些变化非常频繁的数据，例如秒杀页面。")]),a._v(" "),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token response-status"}},[s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token status-code number"}},[a._v("200")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token reason-phrase string"}},[a._v("OK")])]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Cache-Control")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("no-store")])]),a._v("\n")])])]),s("p",[a._v("no-cache：意思是可以缓存，使用之前要去服务器验证是否过期，是否有最新的版本；")]),a._v(" "),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token response-status"}},[s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token status-code number"}},[a._v("200")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token reason-phrase string"}},[a._v("OK")])]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Cache-Control")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("no-cahce")])]),a._v("\n")])])]),s("p",[a._v("must-revalidate：如果缓存不过期就可以继续使用，但过期了如果还想用就必须去服务器验证。")]),a._v(" "),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token response-status"}},[s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token status-code number"}},[a._v("200")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token reason-phrase string"}},[a._v("OK")])]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Cache-Control")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("max-age=30, must-revalidate ")])]),a._v("\n")])])]),s("h3",{attrs:{id:"客户端的缓存控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户端的缓存控制"}},[a._v("#")]),a._v(" 客户端的缓存控制")]),a._v(" "),s("p",[a._v("浏览器也可以发“Cache-Control”，也就是说请求 - 应答的双方都可以用这个字段进行缓存控制，互相协商缓存的使用策略。")]),a._v(" "),s("p",[a._v("用户点击“刷新”按钮的时候，浏览器会在请求头里加一个“Cache-Control: max-age=0”。此时本地缓存里的数据至少保存了几秒钟，所以浏览器就不会使用缓存，而是向服务器发请求。服务器看到 max-age=0，也就会用一个最新生成的报文回应浏览器。")]),a._v(" "),s("p",[a._v("Ctrl+F5 的“强制刷新”其实是发了一个“Cache-Control: no-cache”，含义和“max-age=0”基本一样，就看后台的服务器怎么理解，通常两者的效果是相同的。")]),a._v(" "),s("p",[a._v("浏览器的“前进”“后退”或者重定向时不会夹带 ”Cache-Control“信息，缓存通常在此时生效，直接读取使用磁盘上的缓存。")]),a._v(" "),s("h3",{attrs:{id:"条件请求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#条件请求"}},[a._v("#")]),a._v(" 条件请求")]),a._v(" "),s("p",[a._v("浏览器中的刷新页面动作默认会强制跨过缓存更新数据，对有效缓存的利用是有限的。")]),a._v(" "),s("p",[a._v("为了更好的利用缓存资源，浏览器支持用两个连续的请求组成“验证动作”：先是一个 HEAD，获取资源的修改时间等元信息，然后与缓存数据比较，如果没有改动就使用缓存，节省网络流量，否则就再发一个 GET 请求，获取最新的版本。")]),a._v(" "),s("h4",{attrs:{id:"条件请求字段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#条件请求字段"}},[a._v("#")]),a._v(" 条件请求字段")]),a._v(" "),s("p",[a._v("但两个请求的网络成本还是较高，所以 HTTP 协议就定义了 1 系列“If”开头的“条件请求”字段，专门用来检查验证资源是否过期，把两个请求才能完成的工作合并在 1 个请求里，验证的责任交给服务器。")]),a._v(" "),s("p",[a._v("条件请求字段最常用的是“If-Modified-Since”和“If-None-Match”这两个。"),s("br"),a._v("\n需要第 1 次的响应报文预先提供“Last-modified”和“ETag”，然后第 2 次请求时就可以带上缓存里的原值，验证资源是否是最新的。")]),a._v(" "),s("p",[a._v("如果资源没有变，服务器就回应 1 个“304 Not Modified”，表示缓存依然有效，浏览器更新 1 下有效期然后使用缓存。")]),a._v(" "),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token request-line"}},[s("span",{pre:!0,attrs:{class:"token method property"}},[a._v("GET")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token request-target url"}},[a._v("/")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("www.example.com")])]),a._v("\n")])])]),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token response-status"}},[s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token status-code number"}},[a._v("200")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token reason-phrase string"}},[a._v("OK")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Cache-Control")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("max-age=30")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Last-Modified")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("ETag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v('"5cc168c7-3e"')])]),a._v("\n")])])]),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token request-line"}},[s("span",{pre:!0,attrs:{class:"token method property"}},[a._v("GET")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token request-target url"}},[a._v("/")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("www.example.com")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("If-Modified-Since")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("If-None-Match")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v('"5cc168c7-3e"')])]),a._v("\n")])])]),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token response-status"}},[s("span",{pre:!0,attrs:{class:"token http-version property"}},[a._v("HTTP/1.1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token status-code number"}},[a._v("304")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token reason-phrase string"}},[a._v("Not Modified")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:08:00 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Cache-Control")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("max-age=30")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("Last-Modified")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v("Mon, 23 May 2012 02:07:58 GMT")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token header"}},[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("ETag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token header-value"}},[a._v('"5cc168c7-3e"')])]),a._v("\n")])])]),s("p",[a._v("这里“If-Modified-Since”和“If-None-Match”的精度是秒级，这在计算机中是远远不够的，所以并不能精准判定文件的有效性。")]),a._v(" "),s("p",[a._v("再比如，1 个文件定期更新，有时实际内容并没有变化，此时单纯按照最后更新时间来判定缓存有效明显是不符合预期的。")]),a._v(" "),s("p",[a._v("ETag 是“实体标签”（Entity Tag）的缩写，是资源的 1 个唯 1 标识，类似于 1 个文件内容的指纹，只在内容改变时 ETag 才会变。")]),a._v(" "),s("p",[a._v("ETag 还有“强”“弱”之分。")]),a._v(" "),s("p",[a._v("强 ETag 要求资源在字节级别必须完全相符，弱 ETag 在值前有个“W/”标记，只要求资源在语义上没有变化，但内部可能会有部分发生了改变（例如 HTML 里的标签顺序调整，或者多了几个空格）。")])])}),[],!1,null,null,null);s.default=r.exports}}]);